#!/bin/bash

#SBATCH --partition=gpu_a100
#SBATCH --gpus=1
#SBATCH --job-name=TestLatentsPipeline
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=9
#SBATCH --time=1:00:00
#SBATCH --output=cluster_workflow/jobs/slurm_outputs/test_latents_pipeline_%A.out
#SBATCH --error=cluster_workflow/jobs/slurm_outputs/test_latents_pipeline_%A.err

# Get the script directory and set up paths
module purge
module load 2023
module load Anaconda3/2023.07-2

source activate aurora-highres
CODE_DIR="$HOME/aurora-highres"
EXAMPLES_DIR="$CODE_DIR/examples"
OUTPUT_ZARR="$EXAMPLES_DIR/test_latents_local.zarr"
WORK_DIR="$EXAMPLES_DIR/test_latents_work"

echo "=== LOCAL TEST LATENTS PIPELINE ==="
echo "CODE_DIR: $CODE_DIR"
echo "OUTPUT_ZARR: $OUTPUT_ZARR"
echo "WORK_DIR: $WORK_DIR"

cd "$CODE_DIR"
export PYTHONPATH="."

# Clean up previous run
echo ""
echo "=== Setting up directories ==="
rm -rf "$OUTPUT_ZARR"
rm -rf "$WORK_DIR"
mkdir -p "$WORK_DIR"

# Step 1: Extract latents for a few samples
echo ""
echo "=== Step 1: Extracting latents (max 5 samples) ==="
python examples/run_year_forward_with_latents_zarr.py \
    --start-year 2018 \
    --end-year 2018 \
    --output-zarr "$OUTPUT_ZARR" \
    --work-dir "$WORK_DIR" \
    --max-samples 5

# Step 2: Validate the Zarr structure
echo ""
echo "=== Step 2: Validating latents Zarr ==="
python examples/validate_latents_zarr.py \
    --zarr-path "$OUTPUT_ZARR" \
    --n-timesteps-check 5

# Step 3: Plot the results (will open matplotlib window)
echo ""
echo "=== Step 3: Plotting latents ==="
python examples/plot_region_latents_from_zarr.py \
    --zarr-path "$OUTPUT_ZARR" \
    --time-idx 0 \
    --mode surface \
    --var-name "2t" \
    --n-samples 3

echo ""
echo "=== LOCAL TEST COMPLETE ==="
echo "Zarr saved to: $OUTPUT_ZARR"
echo "Work directory: $WORK_DIR"
